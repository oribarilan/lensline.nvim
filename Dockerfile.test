FROM ubuntu:22.04
ARG NVIM_VERSION=v0.8.3

# Install ONLY what is required to run the lensline test suite:
# - ca-certificates curl xz-utils : fetch & extract Neovim release tarball
# - lua5.1 luarocks               : install luassert (sole test dependency)
# - git                            : provider code shells out to git (parity with runtime)
# - make                           : invoke existing Makefile (run 'make test' exactly)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl xz-utils git lua5.1 luarocks make \
 && rm -rf /var/lib/apt/lists/*

# Install Neovim (binary release)
# NOTE: Skip executing 'nvim --version' during build to avoid Rosetta/QEMU issues on cross-arch (arm64 host building linux/amd64)
RUN curl -fL "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux64.tar.gz" -o /tmp/nvim.tar.gz \
 && tar -xzf /tmp/nvim.tar.gz -C /opt \
 && ln -s /opt/nvim-*/bin/nvim /usr/local/bin/nvim \
 && rm /tmp/nvim.tar.gz

# Copy repository sources
WORKDIR /app
COPY . /app

# Install isolated test dependency tree (pure Lua, no compiler toolchain needed)
RUN rm -rf ./.rocks && \
    luarocks --lua-version=5.1 --tree ./.rocks install luassert

# delegate to Makefile so changes in orchestration need updating only once
CMD ["make","test"]
